<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯Ø±ÙˆØ³ - Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.57.2/dist/umd/supabase.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .info-box {
            background: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .info-box h3 {
            color: #1e40af;
            margin-bottom: 10px;
        }
        .info-box ul {
            color: #475569;
            padding-right: 20px;
            line-height: 1.8;
        }
        .warning-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .warning-box strong {
            color: #b45309;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 20px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        #status {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            display: none;
            font-size: 16px;
            line-height: 1.6;
        }
        .success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        .error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        .loading {
            background: #e0e7ff;
            color: #3730a3;
            border-left: 4px solid #6366f1;
        }
        .progress {
            margin-top: 10px;
            font-size: 14px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø¯Ø±ÙˆØ³ Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±</h1>
        <p class="subtitle">Ø£Ø¯Ø§Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù„Ø¥ØµÙ„Ø§Ø­ ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø¯Ø±ÙˆØ³</p>
        
        <div class="info-box">
            <h3>ğŸ“‹ Ù…Ø§Ø°Ø§ Ø³ØªÙØ¹Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø¯Ø§Ø©ØŸ</h3>
            <ul>
                <li>Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø¨Ø§Ù„ØªØ³Ù„Ø³Ù„ (1, 2, 3...)</li>
                <li>Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ø¯Ø±ÙˆØ³ ÙƒÙ…Ø§ Ù‡Ùˆ</li>
                <li>Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ÙˆØ§Ù„Ø®Ø§Ø·Ø¦Ø© ÙÙŠ order_index</li>
                <li>ØªØ­Ø¯ÙŠØ« 277 Ø¯Ø±Ø³ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
            </ul>
        </div>

        <div class="warning-box">
            <strong>âš ï¸ ØªØ­Ø°ÙŠØ±:</strong> Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø³ØªØ­Ø¯Ø« ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø£ÙˆÙ„Ø§Ù‹.
        </div>

        <button id="fixBtn" onclick="fixLessonsOrder()">
            Ø¨Ø¯Ø¡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨
        </button>

        <div id="status"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://swlwhjnwycvjdhgclwlx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3bHdoam53eWN2amRoZ2Nsd2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMDU4MzgsImV4cCI6MjA3MDg4MTgzOH0.whMWEn_UIrxBa2QbK1leY9QTr1jeTnkUUn3g50fAKus';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
        }

        async function fixLessonsOrder() {
            const btn = document.getElementById('fixBtn');
            btn.disabled = true;
            
            try {
                showStatus('â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'loading');
                
                // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ø±ØªØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
                const { data: lessons, error: fetchError } = await supabaseClient
                    .from('grade11_lessons')
                    .select('id, topic_id, order_index, created_at')
                    .eq('is_active', true)
                    .order('topic_id')
                    .order('order_index')
                    .order('created_at');

                if (fetchError) throw fetchError;

                showStatus(`âœ… ØªÙ… Ø¬Ù„Ø¨ ${lessons.length} Ø¯Ø±Ø³<br>â³ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… Ø§Ù„Ø¯Ø±ÙˆØ³...`, 'loading');

                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ…Ù‡Ø§
                const topicLessons = {};
                lessons.forEach(lesson => {
                    if (!topicLessons[lesson.topic_id]) {
                        topicLessons[lesson.topic_id] = [];
                    }
                    topicLessons[lesson.topic_id].push(lesson);
                });

                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±Ù‚ÙŠÙ… ÙˆØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø¯Ø±Ø³
                let updatedCount = 0;
                let totalLessons = lessons.length;

                for (const topicId in topicLessons) {
                    const lessonsInTopic = topicLessons[topicId];
                    
                    for (let i = 0; i < lessonsInTopic.length; i++) {
                        const lesson = lessonsInTopic[i];
                        const newOrder = i + 1;
                        
                        // ØªØ­Ø¯ÙŠØ« ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ø®ØªÙ„Ù
                        if (lesson.order_index !== newOrder) {
                            const { error: updateError } = await supabaseClient
                                .from('grade11_lessons')
                                .update({ order_index: newOrder })
                                .eq('id', lesson.id);

                            if (updateError) {
                                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø³:', lesson.id, updateError);
                            } else {
                                updatedCount++;
                            }
                        }
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ‚Ø¯Ù…
                        const processed = Object.values(topicLessons)
                            .flat()
                            .indexOf(lesson) + 1;
                        
                        if (processed % 10 === 0 || processed === totalLessons) {
                            showStatus(
                                `â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...<br>` +
                                `<div class="progress">ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${processed} Ù…Ù† ${totalLessons} Ø¯Ø±Ø³ (${Math.round(processed/totalLessons*100)}%)</div>`,
                                'loading'
                            );
                        }
                    }
                }

                showStatus(
                    `âœ… <strong>ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø¨Ù†Ø¬Ø§Ø­!</strong><br><br>` +
                    `ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:<br>` +
                    `â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©: ${totalLessons}<br>` +
                    `â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©: ${updatedCount}<br>` +
                    `â€¢ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹: ${Object.keys(topicLessons).length}<br><br>` +
                    `ğŸ‰ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ³ØªØ¬Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨ ØµØ­ÙŠØ­Ø§Ù‹!`,
                    'success'
                );

                btn.textContent = 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ âœ“';
                
            } catch (error) {
                console.error('Error:', error);
                showStatus(
                    `âŒ <strong>Ø­Ø¯Ø« Ø®Ø·Ø£:</strong><br>${error.message}<br><br>` +
                    `ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.`,
                    'error'
                );
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
